<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ±äº¬ç§æ—… - Tokyo Guide</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .safe-area-bottom { padding-bottom: env(safe-area-inset-bottom); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
    </style>
</head>
<body>
    <div id="app" class="max-w-md mx-auto min-h-screen relative pb-24">
        
        <header class="sticky top-0 z-50 glass border-b p-4 flex justify-between items-center">
            <h1 class="text-xl font-bold text-indigo-600">æ±äº¬ç§æ—… ğŸ‡¯ğŸ‡µ</h1>
            <div class="flex gap-2">
                <span class="bg-indigo-100 text-indigo-700 px-3 py-1 rounded-full text-xs font-medium">2026 Winter</span>
            </div>
        </header>

        <main class="p-4">
            
            <section v-if="activeTab === 'itinerary'" class="space-y-4">
                <div class="flex justify-between items-end">
                    <h2 class="text-2xl font-bold">æ¯æ—¥è¡Œç¨‹</h2>
                    <button @click="addEvent" class="bg-indigo-600 text-white p-2 rounded-full shadow-lg">
                        <i data-lucide="plus"></i>
                    </button>
                </div>

                <div v-for="(item, index) in itinerary" :key="index" class="bg-white rounded-2xl shadow-sm border p-4 flex gap-4 relative group">
                    <div class="flex flex-col items-center border-r pr-4">
                        <span class="text-sm font-bold text-indigo-500">{{ item.time }}</span>
                        <div class="w-0.5 h-full bg-indigo-100 my-1"></div>
                    </div>
                    <div class="flex-1">
                        <h3 class="font-bold text-gray-800">{{ item.location }}</h3>
                        <p class="text-sm text-gray-500">{{ item.note }}</p>
                        <div class="mt-2 flex gap-2">
                            <button @click="openNav(item.location)" class="flex items-center text-xs bg-slate-100 px-2 py-1 rounded text-slate-600">
                                <i data-lucide="map-pin" class="w-3 h-3 mr-1"></i> å°èˆª
                            </button>
                            <button @click="deleteItem('itinerary', index)" class="text-xs text-red-400 opacity-0 group-hover:opacity-100 transition-opacity ml-auto">
                                åˆªé™¤
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <section v-if="activeTab === 'split'" class="space-y-6">
                <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-3xl p-6 text-white shadow-xl">
                    <p class="opacity-80 text-sm">å¹³å‡æ¯äººæ‡‰ä»˜</p>
                    <h2 class="text-3xl font-bold">Â¥ {{ perPersonCost.toLocaleString() }}</h2>
                </div>

                <div class="bg-white rounded-2xl border p-4">
                    <h3 class="font-bold mb-4">æ–°å¢æ”¯å‡º</h3>
                    <div class="space-y-3">
                        <input v-model="newExpense.item" type="text" placeholder="é …ç›® (å¦‚ï¼šä¸€è˜­æ‹‰éºµ)" class="w-full border-none bg-gray-50 rounded-xl p-3 focus:ring-2 focus:ring-indigo-500">
                        <div class="flex gap-2">
                            <input v-model.number="newExpense.amount" type="number" placeholder="é‡‘é¡ (JPY)" class="flex-1 border-none bg-gray-50 rounded-xl p-3">
                            <select v-model="newExpense.payer" class="border-none bg-gray-50 rounded-xl p-3">
                                <option v-for="p in people" :value="p">{{ p }}</option>
                            </select>
                        </div>
                        <button @click="addExpense" class="w-full bg-indigo-600 text-white font-bold py-3 rounded-xl">åŠ å…¥å¸³å–®</button>
                    </div>
                </div>

                <div class="space-y-2">
                    <h3 class="font-bold px-1">æ”¶æ”¯æ˜ç´°</h3>
                    <div v-for="(ex, i) in expenses" :key="i" class="flex justify-between items-center bg-white p-3 rounded-xl border shadow-sm">
                        <div>
                            <p class="font-medium">{{ ex.item }}</p>
                            <p class="text-xs text-gray-400">{{ ex.payer }} æ”¯ä»˜</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-indigo-600">Â¥ {{ ex.amount }}</p>
                            <button @click="deleteItem('expenses', i)" class="text-[10px] text-red-300">æ’¤éŠ·</button>
                        </div>
                    </div>
                </div>

                <div v-if="settlements.length > 0" class="bg-amber-50 border border-amber-200 rounded-2xl p-4">
                    <h3 class="text-amber-800 font-bold mb-2 flex items-center">
                        <i data-lucide="hand-coins" class="w-4 h-4 mr-1"></i> çµç®—å»ºè­°
                    </h3>
                    <div v-for="s in settlements" class="text-sm text-amber-700 py-1">
                        {{ s.from }} âœ çµ¦ {{ s.to }} <span class="font-bold">Â¥ {{ Math.round(s.amount) }}</span>
                    </div>
                </div>
            </section>
        </main>

        <nav class="fixed bottom-6 left-4 right-4 h-16 glass rounded-2xl border shadow-2xl flex items-center justify-around px-6 safe-area-bottom">
            <button @click="activeTab = 'itinerary'" :class="activeTab === 'itinerary' ? 'text-indigo-600' : 'text-gray-400'">
                <i data-lucide="calendar"></i>
                <span class="block text-[10px] mt-1 font-bold">è¡Œç¨‹</span>
            </button>
            <button @click="activeTab = 'split'" :class="activeTab === 'split' ? 'text-indigo-600' : 'text-gray-400'">
                <i data-lucide="wallet"></i>
                <span class="block text-[10px] mt-1 font-bold">åˆ†å¸³</span>
            </button>
            <button @click="openGoogleMaps" class="text-gray-400">
                <i data-lucide="map"></i>
                <span class="block text-[10px] mt-1 font-bold">åœ°åœ–</span>
            </button>
        </nav>

        <div v-if="showModal" class="fixed inset-0 bg-black/50 flex items-center justify-center p-6 z-[60]">
            <div class="bg-white rounded-3xl w-full p-6 space-y-4">
                <h3 class="text-xl font-bold">æ–°å¢è¡Œç¨‹åœ°é»</h3>
                <input v-model="newItem.time" type="time" class="w-full bg-gray-100 rounded-xl p-3">
                <input v-model="newItem.location" type="text" placeholder="åœ°é» (å¦‚ï¼šæ·ºè‰å¯º)" class="w-full bg-gray-100 rounded-xl p-3">
                <input v-model="newItem.note" type="text" placeholder="å‚™è¨»" class="w-full bg-gray-100 rounded-xl p-3">
                <div class="flex gap-2">
                    <button @click="showModal = false" class="flex-1 py-3 text-gray-500 font-bold">å–æ¶ˆ</button>
                    <button @click="saveItem" class="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold">å„²å­˜</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick } = Vue;

        createApp({
            setup() {
                const activeTab = ref('itinerary');
                const showModal = ref(false);
                const people = ref(['æˆ‘', 'å¤¥ä¼´A', 'å¤¥ä¼´B']);
                
                const itinerary = ref([
                    { time: '09:00', location: 'æˆç”°æ©Ÿå ´', note: 'é ˜å– JR Pass' },
                    { time: '13:00', location: 'æ–°å®¿å¾¡è‹‘', note: 'çœ‹æ«»èŠ±/æ¥“è‘‰' }
                ]);

                const expenses = ref([
                    { item: 'æˆç”°ç‰¹å¿«', amount: 9000, payer: 'æˆ‘' },
                    { item: 'ç‡’è‚‰æ™šé¤', amount: 15000, payer: 'å¤¥ä¼´A' }
                ]);

                const newItem = ref({ time: '', location: '', note: '' });
                const newExpense = ref({ item: '', amount: null, payer: 'æˆ‘' });

                // --- Methods ---
                const addEvent = () => { showModal.value = true; };
                const saveItem = () => {
                    if(newItem.value.time && newItem.value.location) {
                        itinerary.value.push({...newItem.value});
                        itinerary.value.sort((a, b) => a.time.localeCompare(b.time));
                        showModal.value = false;
                        newItem.value = { time: '', location: '', note: '' };
                        nextTick(() => lucide.createIcons());
                    }
                };

                const deleteItem = (type, index) => {
                    if(type === 'itinerary') itinerary.value.splice(index, 1);
                    else expenses.value.splice(index, 1);
                };

                const addExpense = () => {
                    if(newExpense.value.item && newExpense.value.amount) {
                        expenses.value.push({...newExpense.value});
                        newExpense.value = { item: '', amount: null, payer: 'æˆ‘' };
                        nextTick(() => lucide.createIcons());
                    }
                };

                const openNav = (loc) => {
                    window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc + ' æ±äº¬')}`, '_blank');
                };

                const openGoogleMaps = () => {
                    window.open('https://www.google.com/maps', '_blank');
                };

                // --- Calculation ---
                const perPersonCost = computed(() => {
                    const total = expenses.value.reduce((sum, ex) => sum + ex.amount, 0);
                    return total / people.value.length;
                });

                const settlements = computed(() => {
                    let balance = {};
                    people.value.forEach(p => balance[p] = -perPersonCost.value);
                    expenses.value.forEach(ex => balance[ex.payer] += ex.amount);

                    let results = [];
                    let debtors = people.value.filter(p => balance[p] < -1).sort((a,b) => balance[a] - balance[b]);
                    let creditors = people.value.filter(p => balance[p] > 1).sort((a,b) => balance[b] - balance[a]);

                    debtors.forEach(d => {
                        creditors.forEach(c => {
                            let amount = Math.min(-balance[d], balance[c]);
                            if (amount > 0) {
                                results.push({ from: d, to: c, amount: amount });
                                balance[d] += amount;
                                balance[c] -= amount;
                            }
                        });
                    });
                    return results;
                });

                onMounted(() => { lucide.createIcons(); });

                return {
                    activeTab, itinerary, expenses, showModal, newItem, newExpense, people,
                    addEvent, saveItem, deleteItem, addExpense, openNav, openGoogleMaps,
                    perPersonCost, settlements
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
